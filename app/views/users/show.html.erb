<%# encoding: utf-8 %>

<% @show_search_stuff = false %>
<% content_for :title, "Utilizador " + @user.id.to_s + " :: GestãoEmergência" %>
<% content_for :page_purpose, "Utilizador " + @user.id.to_s %>

<% content_for :model_actions do %>
    <% if current_user.id == @user.id %>
        <%= link_to edit_user_registration_path, :data => {:position => 'left', :delay => '15',
                                                           :tooltip => 'Editar utilizador'},
                    class: 'tooltipped navbar-button', method: :get do %>
            <i class="material-icons md-36">edit</i>
        <% end %>
    <% elsif current_user.profile == User::ADMINISTRADOR %>
        <%= link_to edit_user_path(@user), :data => {:position => 'left', :delay => '15',
                                                     :tooltip => 'Editar utilizador'},
                    class: 'tooltipped navbar-button', method: :get do %>
            <i class="material-icons md-36">edit</i>
        <% end %>
    <% end %>
<% end %>

<% content_for :back_page do %>
    <%= link_to users_path, :data => {:position => 'right', :delay => '15',
                                      :tooltip => 'Voltar para utilizadores'},
                class: 'tooltipped navbar-button', method: :get do %>
        <i class="material-icons md-36 white-text">arrow_back</i>
    <% end %>
<% end %>


<% if flash[:notice] %>
    <% if flash[:notice].to_s.eql? "edit_success" %>
        <%= javascript_tag "displayFlashMessage('edit_success', 'user')" %>
    <% elsif flash[:notice].to_s.eql? "edit_error" %>
        <%= javascript_tag "displayFlashMessage('edit_error', 'user')" %>
    <% end %>
<% end %>



<div class="container">

  <!-- TODO: ESTE PEQUENO FORM PARA (TEMPORARIAMENTE) ATUALIZAR A POSIÇÃO DO UTILIZADOR -->
  <!-- TODO: TESTANDO ASSIM SE A ATUALIZAÇÃO DAS POSIÇÕES DA EQUIPA QUE É RESPONSAVEL ESTAO CORRECTAS -->
  <!--<div class="row" style="margin-top: 20px;">-->
  <!--<form class="col l12 m12 s12 center-align z-depth-1 profile-div white">-->
  <!--<div class="row">-->
  <!--<div class="input-field col s12">-->
  <!--<input value="POINT()" id="new_coords" type="text" class="validate">-->
  <!--<label for="new_coords">(TESTE) Alterar a posição atual do utilizador [lat lon]:</label>-->
  <!--<a id="update_location" class="waves-effect waves-light btn">-->
  <!--<i class="material-icons right">send</i>Enviar-->
  <!--</a>-->
  <!--</div>-->
  <!--</div>-->
  <!--</form>-->
  <!--</div>-->

  <div class="row" style="margin-top: 20px;">
    <div id="profile-user-info" class="col l4 m12 s12 center-align z-depth-1 profile-div white">
      <div class="col l12 m6 s12">
        <%= image_tag @user.avatar.url(:small), class: 'circle responsive-img' %>
      </div>

      <div class="col l12 m6 s12">
        <h5 style="font-weight: 300;">
          <%= @user.full_name %>
        </h5>

        <div class="divider divider-margin"></div>

        <div style="font-weight: 300;">
          <i class="material-icons tiny">access_time</i>
          <span style="padding-left: 10px"><%= @user.created_at.to_datetime.to_formatted_s(:long_ordinal) %></span>
        </div>

        <div style="font-weight: 300; margin-top: 3px; margin-bottom: 3px;">
          <i class="material-icons tiny">person</i>
          <span style="padding-left: 10px"><%= @user.profile %></span>
        </div>

        <div style="font-weight: 300; margin-top: 3px; margin-bottom: 3px;">
          <i class="material-icons tiny">mail</i>
          <span style="padding-left: 10px"><%= @user.email %></span>
        </div>

        <div style="font-weight: 300; margin-top: 3px;">
          <i class="material-icons tiny">phone</i>
          <span style="padding-left: 10px"><%= @user.phone_number %></span>
        </div>
      </div>
    </div>

    <div id="user_coordinates" class="center-align col s12 m12 l8 z-depth-1 white"
         style="padding-left: 20px; padding-top: 0px; padding-bottom: 20px; padding-right: 20px;">
      <h5 style="font-weight: 300;">Posição atual</h5>

      <div class="divider divider-margin"></div>

      <div id="user_map" style="height: 350px;"></div>
    </div>
  </div>

  <div class="row z-depth-1 white">
    <div class="profile-tabs col s12 m12 l12 z-depth-1 white">
      <div>
        <ul id="profile-tabs-list" class="tabs">
          <li class="tab col s6">
            <a class="stay-where-you-are active" href="#user-teams">
              Equipas (<%= @user_teams.count %>)
            </a>
          </li>
          <li class="tab col s6">
            <a href="#user-entities" class="stay-where-you-are">
              Entidades (<%= @user_entities.count %>)
            </a>
          </li>
        </ul>
      </div>

      <div id="user-teams" class="col s12 profile-tab-content">
        <ul class="collection with-header">
          <li class="collection-header"><h5>Equipas a que pertence</h5></li>

          <% if @user_teams.count == 0 %>
              <li class="collection-item">
                Não pertence a nenhuma equipa
              </li>
          <% else %>
              <% @user_teams.each do |team| %>
                  <% team_entry = @user_team_members.where(team_id: team.id).first %>
                  <%= puts "USERS SHOW USERS SHOW" %>
                  <%= puts team_entry.inspect %>
                  <li class="collection-item">
                    <div>
                      <strong>
                        <span style="font-size: 15px;"><%= team.name %></span>
                        <span> | </span>
                        <% if team_entry.is_leader? %>
                            <span style="font-size: 12px;">Chefe</span>
                        <% else %>
                            <span style="font-size: 12px;">Membro</span>
                        <% end %>
                      </strong>

                      <%= link_to team, :data => {:position => 'left', :delay => '15',
                                                  :tooltip => 'Ir para a equipa'},
                                  class: 'tooltipped secondary-content', method: :get do %>
                          <i class="material-icons">send</i>
                      <% end %>
                    </div>
                  </li>
              <% end %>
          <% end %>

        </ul>
      </div>
      <div id="user-entities" class="col s12 profile-tab-content">
        <ul class="collection with-header">
          <li class="collection-header"><h5>Entidades que adicionou</h5></li>
          <% if @user_entities.count == 0 %>
              <li class="collection-item">
                Não criou nenhuma entidade
              </li>
          <% else %>
              <% @user_entities.each do |entity| %>
                  <%= puts "ENTYITY ENTITYTHIUTR" %>
                  <%= puts entity.inspect %>
                  <li class="collection-item">
                    <div>
                      <strong>
                        <span style="font-size: 15px;"><%= entity.name %></span>
                        <span> | </span>
                        <span style="font-size: 12px;"><%= entity.entity_type %></span>
                        <span> | </span>
                      </strong>
                      <span class="entity-latlon" style="font-size: 12px;"><%= entity.latlon %></span>
                      <a data-position="left" onclick="goToGeoEntity(<%= entity.id %>)" data-delay="15" data-tooltip="Centrar mapa"
                         class="tooltipped secondary-content">
                        <i class="material-icons">my_location</i>
                      </a>
                    </div>
                  </li>
              <% end %>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
</div>