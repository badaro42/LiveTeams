var osm, osmUrl;
var team_map, user_map;
var curr_marker = undefined, remove_btn;
var cluster;
var parent_list_entry_id, username_to_be_removed, user_role_to_be_removed;
var uri;

// variaveis da cena da search bar
var allEntityEntries, allEntityNames, entityNamesIndexed = [], entityEntriesIndexed = [];
var searchBar, noResultsDiv;

var team_highlight_icon = L.icon({
  iconUrl: '/assets/bullseye-64.png',
  iconSize: [38, 38], // size of the icon
  iconAnchor: [19, 30], // point of the icon which will correspond to marker's location
  popupAnchor: [-1, -30] // point from which the popup should open relative to the iconAnchor
});


$(document).ready(function () {
  $(".button-collapse").sideNav();

  cluster = L.markerClusterGroup({chunkedLoading: true});

  // atualizar posição do utilizador
  $("#update_location").click(function (e) {
    console.log("CARREGUEI NO BOTAO PARA ATUALIZAR POSIÇÃO");
    var text_coords = $("#new_coords").val();
    var c_arr = parsePointCoordinates(text_coords);

    console.log("Latitude: " + c_arr[1]);
    console.log("Longitude: " + c_arr[0]);

    $.ajax({
      type: "POST",
      url: "/update_location",
      data: {
        latitude: c_arr[1],
        longitude: c_arr[0],
        user_id: gon.user_id
      },
      success: function (result) {
        console.log(result);
        $("#new_coords").val('POINT()');
      },
      error: function (err) {
        console.log(err);
        $("#new_coords").val('Erro a atualizar coordenadas!');
      }
    });
  });

  uri = document.location;
  var href = uri.pathname;
  var users_pages = href.indexOf("users") > -1;
  var teams_pages = href.indexOf("teams") > -1;
  var account_pages = href.indexOf("account") > -1;
  var edit_page = href.indexOf("edit") > -1;
  var new_page = href.indexOf("new") > -1;

  // caso haja uma barra no final do url, remove-a
  if (href[href.length - 1].localeCompare("/") == 0)
    href = href.substring(0, href.length - 1);

  // verificamos se o ultimo char do url é um numero
  // se sim, estamos na pagina do show, seja user ou equipa
  var is_a_number = !isNaN(parseInt(href[href.length - 1]));
  var text_coords, point_coords;

  // TODO: COLOCAR PAGINAS ESPECIFICAS EM CIMA!!!
  // TODO: EX: /users/new antes de /users
  // estamos na pagina para editar equipa - /teams/12/edit
  if (teams_pages) {
    if (edit_page) {
      // TODO: MAPA COM LOCALIZAÇÃO ATUAL, PERMITE ARRASTAR MARCADOR!
      console.log("PÁGINA PARA EDITAR EQUIPA!!!");

      text_coords = $('#team_latlon_highlight').val();

      // a equipa nao esta destacada para lado nenhum
      if (text_coords.length == 0) {
        point_coords = L.latLng(38.627881, -9.161007);
      }
      else {
        var coords_arr = parsePointCoordinates(text_coords);
        point_coords = L.latLng(coords_arr[1], coords_arr[0]);
      }

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 19});
      team_map = L.map("team_map", {
        zoom: 12,
        center: point_coords,
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      remove_btn = L.easyButton('fa-trash-o', function () {
        if (confirm("Pretende remover o destaque da equipa?")) {
          if (typeof curr_marker !== 'undefined') {
            team_map.removeLayer(curr_marker);
            $("#team_latlon_highlight").attr("value", null);
            remove_btn.disable();
          }
        }
      });

      remove_btn.disable();
      remove_btn.addTo(team_map);

      // apenas adicionar o marcador caso a equipa tenha localizaçao
      if (text_coords.length > 0) {
        var marker = L.marker(point_coords, {icon: team_highlight_icon}).addTo(team_map);
        var p_content = "<span>Esta equipa está destacada para as<br>seguintes coordenadas:</span>" +
            "<p>Latitude: <b>" + point_coords.lat + "</b>,<br>Longitude: <b>" +
            point_coords.lng + "</b></p>";
        marker.bindPopup(p_content).openPopup();
        curr_marker = marker;

        remove_btn.enable();
      }

      // adiciona um listener ao mapa para o evento "clique"
      team_map.on('click', onMapClick);
    }
    else if (new_page) {
      // TODO: MAPA VAZIO
      console.log("PÁGINA PARA CRIAR NOVA EQUIPA!!!");

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 19});
      team_map = L.map("team_map", {
        zoom: 12,
        center: [38.627881, -9.161007],
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      remove_btn = L.easyButton('fa-trash-o', function () {
        if (confirm("Pretende remover o destaque da equipa?")) {
          if (typeof curr_marker !== 'undefined') {
            team_map.removeLayer(curr_marker);
            $("#team_latlon_highlight").attr("value", null);
            remove_btn.disable();
          }
        }
      });

      remove_btn.disable();
      remove_btn.addTo(team_map);

      // adiciona um listener ao mapa para o evento "clique"
      team_map.on('click', onMapClick);
    }
    else if (is_a_number) {
      console.log("PÁGINA PARA APRESENTAR INFO DA EQUIPA!!!");
      checkUsersWithoutTeam();

      // LISTENER PARA QUANDO O ADMIN ADICIONA UM USER À EQUIPA
      $('#confirm_add_user').on('click', addUserToTeam);

      // abre o modal para confirmar a remoção do membro da equipa
      $('.remove-user-from-team').on('click', openConfirmRemovalModal);

      // o admin carregou no botao para remover o membro. vamos entao fazer-lhe a vontade
      $('#modal_confirm_removal').on('click', function (e) {
        var user_id = parseInt(parent_list_entry_id.split("_")[1]);

        console.log(parent_list_entry_id);
        console.log(user_id);

        removeUserFromTeam(parent_list_entry_id, user_id);
      });

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 19});
      team_map = L.map("team_map", {
        zoom: 12,
        center: [38.627881, -9.161007],
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      console.log(gon.team_versions);

      var i = 0;
      // isto só é null quando a equipa acabou de ser criada!!
      if (gon.team_versions[0] == null) {
        i = 1;
        console.log("tou aqui dentro!!! ;D");
      }

      var counter = 1;
      var last_coords = L.latLng(0, 0); //apenas para inicializar

      // processa todas as posições anteriores (excepto a atual!!!!)
      var bounds_arr = [], c_arr, obj, popupContent;
      for (; i < gon.team_versions.length; i++) {

        if (gon.team_versions[i].hasOwnProperty('team'))
          obj = gon.team_versions[i].team;
        else
          obj = gon.team_versions[i];

        // caso ainda nao haja nenhuma localização!!
        if (obj.latlon !== null) {
          c_arr = parsePointCoordinates(obj.latlon);
          point_coords = L.latLng(c_arr[1], c_arr[0]);

          if (!last_coords.equals(point_coords)) {
            var date1 = new Date(obj.updated_at);
            var date2 = Date.now();
            var seconds = (date2 - date1) / 1000;
            //pos 0 - dias; pos 1 - horas; pos 2 - minutos; pos 3 - segundos
            var time_arr = secondsTimeSpanToHMS(seconds).split(':');
            console.log(time_arr);

            curr_marker = L.marker(point_coords, {icon: new L.NumberedDivIcon({number: counter})});
            popupContent = "<span>A equipa esteve neste ponto com</span><p>Latitude: <b>" +
                curr_marker.getLatLng().lat + "</b>,<br> Longitude: <b>" + curr_marker.getLatLng().lng +
                "</b></p><span> há <b>" + time_arr[0] + "</b> " +
                (time_arr[0] == 1 ? "dia" : "dias") + ", <b>" + time_arr[1] + "</b> " +
                (time_arr[1] == 1 ? "hora" : "horas") + ", <b>" + time_arr[2] + "</b> " +
                (time_arr[2] == 1 ? "minuto" : "minutos") + " e <b>" + Math.floor(time_arr[3]) + "</b> " +
                (time_arr[3] == 1 ? "segundo" : "segundos") + ".</span>";
            curr_marker.bindPopup(popupContent);

            cluster.addLayer(curr_marker);
//            team_map.addLayer(cluster);

            bounds_arr.push(point_coords);
            counter++;
            last_coords = point_coords;
          }
        }
      }

      // processa a posição atual da equipa!!
      c_arr = parsePointCoordinates(gon.current_latlon);
      point_coords = L.latLng(c_arr[1], c_arr[0]);

      if (!last_coords.equals(point_coords)) {
        curr_marker = L.marker(point_coords, {icon: new L.NumberedDivIcon({number: counter})});
        popupContent = "<span>Localização mais recente desta equipa.</span><p>Latitude: <b>" +
            curr_marker.getLatLng().lat + "</b>,<br> Longitude: <b>" + curr_marker.getLatLng().lng +
            "</b></p>";
        curr_marker.bindPopup(popupContent);

        cluster.addLayer(curr_marker);
        bounds_arr.push(point_coords);
      }

      // devolve as coordenadas do destaque da equipa
      text_coords = gon.highlight_latlon;

      // se estiver a null a equipa nao esta destacada.
      if (text_coords != null) {
        c_arr = parsePointCoordinates(text_coords);
        point_coords = L.latLng(c_arr[1], c_arr[0]);

        curr_marker = L.marker(point_coords, {icon: team_highlight_icon}).addTo(team_map);
        popupContent = "<span>Esta equipa está destacada para as<br>seguintes coordenadas:</span>" +
            "<p>Latitude: <b>" + curr_marker.getLatLng().lat + "</b>,<br>Longitude: <b>" +
            curr_marker.getLatLng().lng + "</b></p>";
        curr_marker.bindPopup(popupContent);

//        cluster.addLayer(curr_marker);
        bounds_arr.push(point_coords);
      }

      team_map.addLayer(cluster);

      console.log(bounds_arr);
      team_map.fitBounds(bounds_arr);
    }
    else {
      console.log("PÁGINA COM TODOS AS EQUIPAS!!!");
      initSearchEngine('team');
    }
  }
  // estamos na pagina para apresentar utilizador - /users/12
  else if (users_pages || account_pages) {
    if (is_a_number) {
      console.log("PÁGINA PARA APRESENTAR UTILIZADOR!!!");

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 19});
      user_map = L.map("user_map", {
        zoom: 12,
        center: L.latLng(38.627881, -9.161007),
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      var center, coords_arr, c_marker;
      if (gon.curr_user_pos !== null) {
        coords_arr = parsePointCoordinates(gon.curr_user_pos);
        center = L.latLng(coords_arr[1], coords_arr[0]);
        user_map.panTo(center);

        c_marker = L.marker(center).addTo(user_map);
        popupContent = "<span>Este utilizador encontra-se neste ponto<br> com as seguintes coordenadas:</span>" +
            "<p>Latitude: <b>" + c_marker.getLatLng().lat + "</b>,<br>Longitude: <b>" +
            c_marker.getLatLng().lng + "</b></p>";
        c_marker.bindPopup(popupContent).openPopup();
      }
    }
    else if (edit_page) {
      console.log("PÁGINA PARA editar UTILIZADOR!!!");

      // apenas permite numeros no campo do numero de telefone
      $(".numeric").numeric();

      // barra lateral que acompanha o scroll - pagina para editar utilizador
      $('.pushpin').pushpin({top: 84, offset: 74});
      $('.scrollspy').scrollSpy();
    }
    else {
      console.log("PÁGINA COM TODOS OS UTILIZADORES!!!");
      initSearchEngine('user');
    }
  }

  // Toggle search
  $('a#toggle-search').click(function () {
    var search = $('div#search');
    if (search.is(":visible")) {
      search.slideUp({queue: false});
      $('#page-content').animate({'margin-top': '0', queue: false});
    }
    else {
      search.slideDown({queue: false}, function () {
        search.find('input').focus();
      });
      $('#page-content').animate({'margin-top': '71px', queue: false});
    }
    return false;
  });

  /**
   * Listener para quando uma checkbox é marcada ou desmarcada
   */
  $('input:checkbox').change(
      function () {
        // select para escolher o lider
        var select_leader = $('#select_team_leader');
        // select para escolher o user responsavel pela posição da equipa
        var select_team_position = $('#select_team_position');
        var i_value, i_text;

        var len = $("input[name='team[users][]']:checked").length;
        console.log(len);

        if (len > 0)
          $('#team-submit-form').removeClass("disabled");
        else if (len == 0)
          $('#team-submit-form').addClass("disabled");

        if ($(this).is(':checked')) {
          i_value = $(this).prop('value');
          i_text = $(this).next("label").text();

          console.log("++++++ CHECKED ++++++");
          console.log(i_value);
          console.log(i_text);

          select_leader.append($("<option/>", {
            value: i_value,
            text: i_text
          }));
          select_team_position.append($("<option/>", {
            value: i_value,
            text: i_text
          }));
        }
        else if (!($(this).is(':checked'))) {
          i_value = $(this).prop('value');
          console.log("------ UNCHECKED ------");
          $("#select_team_leader option[value=" + i_value + "]").remove();
          $("#select_team_position option[value=" + i_value + "]").remove();
        }
      }
  );

  // inicializa a select box para escolher o lider
  $('select').material_select();
});

/**
 * Este método � executado quando o utilizador carrega no mapa no formulario das equipas
 * Come�a por verificar se ja h� marcador no mapa: se sim, remove-o.
 * A seguir cria um novo marcador no ponto em que o utilizador carregou e abre uma popup
 * com a localiza��o (USAR GEOCODING???)
 */
function onMapClick(e) {
  // o marcador ja foi inicializado, vamos remov�-lo
  if (typeof curr_marker !== "undefined")
    team_map.removeLayer(curr_marker);

  console.log(e);

  var popupContent = "<span>Destaque alterado para as coordenadas:</span>" +
      "<p>Latitude: <b>" + e.latlng.lat + "</b>,<br> Longitude: <b>" + e.latlng.lng + "</b>.</p>";

  curr_marker = L.marker([e.latlng.lat, e.latlng.lng], {icon: team_highlight_icon}).addTo(team_map);
  curr_marker.bindPopup(popupContent).openPopup();

  var new_val = "POINT (" + e.latlng.lng + " " + e.latlng.lat + ")";
  $("#team_latlon_highlight").attr("value", new_val);

  remove_btn.enable();
}

// o parametro "coords" � da forma -> "POINT(33.333 11.111)"
// retorna um vector com 2 posi�oes, uma para cada coordenada
function parsePointCoordinates(coords) {
  var split_res = coords.split("(");
  var new_split_res = split_res[1].split(" ");

  var res = [];
  res.push(new_split_res[0]); //latitude
  res.push(new_split_res[1].split(")")[0]); //longitude

  return res;
}

function secondsTimeSpanToHMS(s) {
  var d = Math.floor(s / 86400); // Get days
  s -= d * 86400;
  var h = Math.floor(s / 3600); //Get whole hours
  s -= h * 3600;
  var m = Math.floor(s / 60); //Get remaining minutes
  s -= m * 60;
  return d + ":" + h + ":" + m + ":" + s;
}

// função para mostrar as notificações quando um utilizador ou equipa é atualizado
function displayFlashMessage(param, resource) {
  if (param === 'edit_success') {
    if (resource === 'user')
      noty({text: 'O utilizador foi atualizado com sucesso!', timeout: 3500, type: 'success', layout: 'bottomCenter'});
    else if (resource === 'team')
      noty({text: 'A equipa foi atualizada com sucesso!', timeout: 3500, type: 'success', layout: 'bottomCenter'});
  }
  else if (param === 'create_success') {
    if (resource === 'team')
      noty({text: 'A equipa foi criada com sucesso!', timeout: 3500, type: 'success', layout: 'bottomCenter'});
  }
  else if (param === 'edit_error') {
    if (resource === 'user')
      noty({text: 'Erro a atualizar o utilizador!', timeout: 3500, type: 'error', layout: 'bottomCenter'});
    else if (resource === 'team')
      noty({text: 'Erro a atualizar a equipa!', timeout: 3500, type: 'error', layout: 'bottomCenter'});
  }
}

// inicializa as variaveis para o motor de pesquisa dos users ou teams
function initSearchEngine(param) {
  noResultsDiv = $('.no-results');
  searchBar = $('#search-bar');
  entityEntriesIndexed = [];
  entityNamesIndexed = [];

  if (param === 'team') {
    allEntityEntries = $(".team-entry");
    allEntityNames = $(".team-title");
  }
  else if (param === 'user') {
    allEntityEntries = $(".user-card");
    allEntityNames = $(".card-title");
  }

  // nomes das entidades a filtrar
  $.each(allEntityNames, function () {
    entityNamesIndexed.push($(this).text().replace(/\s{2,}/g, ' ').toLowerCase());
  });

  // div das varias entidades na pagina
  $.each(allEntityEntries, function () {
    entityEntriesIndexed.push($(this));
  });

  searchBar.on('keyup', searchListenerKeyPressed);
}

// função executada sempre que é introduzida uma letra na caixa de pesquisa
function searchListenerKeyPressed(param) {
  console.log("letra introduzida na search-bar!");

  if (param.keyCode == 13) { //tecla enter
    searchBar.trigger('blur');
    return true;
  }

  var entity;
  var entityEntry;
  var search_val = $.trim(searchBar.val()).toLowerCase(); // remove espaços brancos antes e dps da palavra

  allEntityNames.each(function () {
    entity = $(this);
    entity.html(entity.html().replace(/<span class="highlight">([^<]+)<\/span>/gi, '$1'));
  });

  if (search_val.length > 0) {
    for (var i in entityNamesIndexed) {
      entity = allEntityNames.eq(i);
      entityEntry = allEntityEntries.eq(i);

      if (entityNamesIndexed[i].indexOf(search_val) != -1) {
        entityEntry.removeClass('is-hidden');
        entity.html(entity.html()
            .replace(new RegExp(search_val + '(?!([^<]+)?>)', 'gi'), '<span class="highlight">$&</span>'));
      }
      else
        entityEntry.addClass('is-hidden');
    }
  }
  else
    $.each(allEntityEntries, function () {
      $(this).removeClass('is-hidden');
    });

  console.log(allEntityEntries.not('.is-hidden').length == 0);

  // ativa a div com a mensagem a dizer que nenhum utilizador foi encontrado
  noResultsDiv.toggleClass('is-visible', allEntityEntries.not('.is-hidden').length == 0);
}

// função responsavel por associar o utilizador selecionado à equipa atual
function addUserToTeam(e) {
  e.preventDefault();
  var selected_item = $('#dropdown_add_user_to_team').find(":selected");

  if (selected_item.text() === "Escolha um utilizador")
    noty({
      text: 'Não selecionou nenhum utilizador.',
      timeout: 3500, type: 'error', layout: 'bottomCenter'
    });
  else {
    var selected_user_id = parseInt(selected_item[0].value);
    console.log(selected_item);
    console.log(selected_user_id);

    $.ajax({
      type: "POST",
      url: "/add_user_to_team",
      data: {
        user_id: selected_user_id,
        team_id: gon.current_team_id
      },
      success: function (result) {
        console.log(result);
        console.log("sucesso add_user_to_team");

        // append da nova entrada à lista de membros
        $(".collection").append(result);

        // atualiza a contagem de elementos na equipa
        var entries_count = $('.collection li').length;
        console.log(entries_count);
        $("#team_members_count").text("Membros (" + entries_count + ")");

        // faz um scroll para a entrada acabada de criar
        $('body, html').animate({scrollTop: $('.collection li:last-child').offset().top}, 1000);

        //remove a entrada da dropdown para impedir que se introduza o mesmo user outra vez
        $("#dropdown_add_user_to_team option[value='" + selected_user_id + "']").remove();
        checkUsersWithoutTeam();

        noty({
          text: 'O utilizador foi adicionado com sucesso à equipa!',
          timeout: 3500, type: 'success', layout: 'bottomCenter'
        });

        // inicializa a tooltip da entrada acabada de introduzir!
        // o mesmo para o listener do remove
        $('.tooltipped').tooltip({delay: 15});
        $('.collection li:last-child > a').on('click', openConfirmRemovalModal);
      },
      error: function (err) {
        console.log("erro add_user_to_team");
        noty({
          text: 'Ocorreu um erro ao adicionar o utilizador à equipa!',
          timeout: 3500, type: 'error', layout: 'bottomCenter'
        });
      }
    });
  }
}

function removeUserFromTeam(entry_id_to_remove, user_id) {
  var entry_to_remove = $('#' + entry_id_to_remove);
  console.log(entry_to_remove);
  console.log(entry_id_to_remove);

  $.ajax({
    type: "POST",
    url: "/remove_user_from_team",
    data: {
      user_id: user_id,
      team_id: gon.current_team_id
    },
    success: function (result) {
      console.log(result);
      console.log("sucesso remove_user_to_team");

      // remove a entrada da lista correspondente ao utilizador
      // o codigo da atualização tem que estar aqui dentro pois o metodo animate recebe um parametro
      // que atrasa a execução do remove por meio segundo, o que fazia com que a contagem desse valores errados
      entry_to_remove.animate({opacity: 0}, 500, function () {
        entry_to_remove.remove();

        // atualiza a contagem de elementos na equipa
        var entries_count = $('.collection li').length;
        console.log(entries_count);
        $("#team_members_count").text("Membros (" + entries_count + ")");

        //remove a entrada da dropdown para impedir que se introduza o mesmo user outra vez
        $("optgroup[label='" + user_role_to_be_removed + "']").append($('<option></option>').val(user_id).text(username_to_be_removed));
        checkUsersWithoutTeam();

        noty({
          text: 'O utilizador foi removido com sucesso da equipa!',
          timeout: 3500, type: 'success', layout: 'bottomCenter'
        });
      });
    },
    error: function (err) {
      console.log("erro a remover o membro da equipa");
      noty({
        text: 'Ocorreu um erro ao remover o membro da equipa!',
        timeout: 3500, type: 'error', layout: 'bottomCenter'
      });
    }
  });
}

function openConfirmRemovalModal() {
  // $('this') representa o botao. o seu pai é a entrada que queremos remover.
  var parent = $(this).parent();

  user_role_to_be_removed = parent.find('.user-role').text();
  parent_list_entry_id = parent.attr('id');
  username_to_be_removed = parent.find('.username').text().trim();

  console.log("username_to_be_removed: " + username_to_be_removed);
  console.log("user_role_to_be_removed: " + user_role_to_be_removed);

  $('#modal_user_name').text(username_to_be_removed);
  $('#remove_user_confirm').openModal();
}

// verifica se há utilizadores na dropdown
// caso nao haja, esconde o formulario a apresenta uma mensagem a informar que nao ha users sem equipa
function checkUsersWithoutTeam() {
  if ($('#dropdown_add_user_to_team option').length == 1) {
    $('#add_user_form').css('display', 'none');
    $('#no_user_to_add').css('display', 'block');
  }
  else {
    $('#add_user_form').css('display', 'block');
    $('#no_user_to_add').css('display', 'none');
  }
}

// redirecciona para a pagina principal e centra o mapa na entidade selecionada
function goToGeoEntity(entity_id) {
  var new_uri = "http://" + uri.host + "?entity_id=" + entity_id;
  console.log(new_uri);
  window.location.replace(new_uri);
}

//function updateQueryStringParameter(param_uri, key, value) {
//  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
//  var separator = param_uri.indexOf('?') !== -1 ? "&" : "?";
//  if (param_uri.match(re)) {
//    return param_uri.replace(re, '$1' + key + "=" + value + '$2');
//  }
//  else {
//    return param_uri + separator + key + "=" + value;
//  }
//}