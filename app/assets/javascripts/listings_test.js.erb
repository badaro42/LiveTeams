var osm, team_map, osmUrl;
var curr_marker = undefined, remove_btn;
var cluster;

var team_highlight_icon = L.icon({
  iconUrl: '/assets/bullseye-64.png',
  iconSize: [38, 38], // size of the icon
  iconAnchor: [19, 30], // point of the icon which will correspond to marker's location
  popupAnchor: [-1, -30] // point from which the popup should open relative to the iconAnchor
});


$(document).ready(function () {

  cluster = L.markerClusterGroup({chunkedLoading: true});

  // atualizar posição do utilizador
  $("#update_location").click(function (e) {
    console.log("CARREGUEI NO BOTAO PARA ATUALIZAR POSIÇÃO");
    console.log($("#new_coords").val());

    $.ajax({
      type: "POST",
      url: "/update_location",
      data: {
        latlon: $("#new_coords").val(),
        user_id: gon.user_id
      },
      success: function (result) {
        console.log(result);
        $("#new_coords").val('POINT()');
      },
      error: function (err) {
        console.log(err);
        $("#new_coords").val('Erro a atualizar coordenadas!');
      }
    });
  });

  var href = document.location.pathname;
  var users_pages = href.indexOf("users") > -1;
  var teams_pages = href.indexOf("teams") > -1;
  var edit_page = href.indexOf("edit") > -1;
  var new_page = href.indexOf("new") > -1;

  // caso haja uma barra no final do url, remove-a
  if (href[href.length - 1].localeCompare("/") == 0)
    href = href.substring(0, href.length - 1);

  // verificamos se o ultimo char do url é um numero
  // se sim, estamos na pagina do show, seja user ou equipa
  var is_a_number = !isNaN(parseInt(href[href.length - 1]));
  var text_coords, point_coords;

  // TODO: COLOCAR PAGINAS ESPECIFICAS EM CIMA!!!
  // TODO: EX: /users/new antes de /users
  // estamos na pagina para editar equipa - /teams/12/edit
  if (teams_pages) {
    if (edit_page) {
      // TODO: MAPA COM LOCALIZAÇÃO ATUAL, PERMITE ARRASTAR MARCADOR!
      console.log("PÁGINA PARA EDITAR EQUIPA!!!");

      text_coords = $('#team_latlon_highlight').val();

      // a equipa nao esta destacada para lado nenhum
      if (text_coords.length == 0) {
        point_coords = L.latLng(38.627881, -9.161007);
      }
      else {
        var coords_arr = parsePointCoordinates(text_coords);
        point_coords = L.latLng(coords_arr[1], coords_arr[0]);
      }

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 20});
      team_map = L.map("team_map", {
        zoom: 12,
        center: point_coords,
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      remove_btn = L.easyButton('fa-trash-o', function () {
        if (confirm("Pretende remover o destaque da equipa?")) {
          if (typeof curr_marker !== 'undefined') {
            team_map.removeLayer(curr_marker);
            $("#team_latlon_highlight").attr("value", null);
            remove_btn.disable();
          }
        }
      });

      remove_btn.disable();
      remove_btn.addTo(team_map);

      // apenas adicionar o marcador caso a equipa tenha localizaçao
      if (text_coords.length > 0) {
        var marker = L.marker(point_coords, {icon: team_highlight_icon}).addTo(team_map);
        var p_content = "<span>Esta equipa está destacada para as<br>seguintes coordenadas:</span>" +
            "<p>Latitude: <b>" + point_coords.lat + "</b>,<br>Longitude: <b>" +
            point_coords.lng + "</b></p>";
        marker.bindPopup(p_content).openPopup();
        curr_marker = marker;

        remove_btn.enable();
      }

      // adiciona um listener ao mapa para o evento "clique"
      team_map.on('click', onMapClick);
    }
    else if (new_page) {
      // TODO: MAPA VAZIO
      console.log("PÁGINA PARA CRIAR NOVA EQUIPA!!!");

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 20});
      team_map = L.map("team_map", {
        zoom: 12,
        center: [38.627881, -9.161007],
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      remove_btn = L.easyButton('fa-trash-o', function () {
        if (confirm("Pretende remover o destaque da equipa?")) {
          if (typeof curr_marker !== 'undefined') {
            team_map.removeLayer(curr_marker);
            $("#team_latlon_highlight").attr("value", null);
            remove_btn.disable();
          }
        }
      });

      remove_btn.disable();
      remove_btn.addTo(team_map);

      // adiciona um listener ao mapa para o evento "clique"
      team_map.on('click', onMapClick);
    }
    else if (is_a_number) {
      // TODO: MAPA COM LOCALIZAÇÃO ATUAL, NAO DEVE PERMITIR ALTERAÇÕES
      console.log("PÁGINA PARA APRESENTAR INFO DA EQUIPA!!!");

      osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      osm = L.tileLayer(osmUrl, {maxZoom: 20});
      team_map = L.map("team_map", {
        zoom: 12,
        center: [38.627881, -9.161007],
        layers: [osm],
        zoomControl: true,
        attributionControl: false
      });

      console.log(gon.team_versions);

      console.log("TEM PROPRIEDADE 'TEAM'??");
      console.log(gon.team_versions[1].hasOwnProperty('team'));

      var i = 0;
      // isto só é null quando a equipa acabou de ser criada!!
      if (gon.team_versions[0] == null) {
        i = 1;
        console.log("tou aqui dentro!!! ;D");
      }

      var counter = 1;
      var last_coords = L.latLng(0, 0); //apenas para inicializar

      // processa todas as posições anteriores (excepto a atual!!!!)
      var bounds_arr = [], c_arr, obj, popupContent;
      for (; i < gon.team_versions.length; i++) {

        if (gon.team_versions[i].hasOwnProperty('team'))
          obj = gon.team_versions[i].team;
        else
          obj = gon.team_versions[i];

        // caso ainda nao haja nenhuma localização!!
        if (obj.latlon !== null) {
          c_arr = parsePointCoordinates(obj.latlon);
          point_coords = L.latLng(c_arr[1], c_arr[0]);

          if (!last_coords.equals(point_coords)) {
            var date1 = new Date(obj.updated_at);
            var date2 = Date.now();
            var seconds = (date2 - date1) / 1000;
            //pos 0 - dias; pos 1 - horas; pos 2 - minutos; pos 3 - segundos
            var time_arr = secondsTimeSpanToHMS(seconds).split(':');
            console.log(time_arr);

            curr_marker = L.marker(point_coords, {icon: new L.NumberedDivIcon({number: counter})});
            popupContent = "<span>A equipa esteve neste ponto com</span><p>Latitude: <b>" +
                curr_marker.getLatLng().lat + "</b>,<br> Longitude: <b>" + curr_marker.getLatLng().lng +
                "</b></p><span> há <b>" + time_arr[0] + "</b> " +
                (time_arr[0] == 1 ? "dia" : "dias") + ", <b>" + time_arr[1] + "</b> " +
                (time_arr[1] == 1 ? "hora" : "horas") + ", <b>" + time_arr[2] + "</b> " +
                (time_arr[2] == 1 ? "minuto" : "minutos") + " e <b>" + Math.floor(time_arr[3]) + "</b> " +
                (time_arr[3] == 1 ? "segundo" : "segundos") + ".</span>";
            curr_marker.bindPopup(popupContent);

            cluster.addLayer(curr_marker);
//            team_map.addLayer(cluster);

            bounds_arr.push(point_coords);
            counter++;
            last_coords = point_coords;
          }
        }
      }

      // processa a posição atual da equipa!!
      c_arr = parsePointCoordinates(gon.current_latlon);
      point_coords = L.latLng(c_arr[1], c_arr[0]);

      if (!last_coords.equals(point_coords)) {
        curr_marker = L.marker(point_coords, {icon: new L.NumberedDivIcon({number: counter})});
        popupContent = "<span>Localização mais recente desta equipa.</span><p>Latitude: <b>" +
            curr_marker.getLatLng().lat + "</b>,<br> Longitude: <b>" + curr_marker.getLatLng().lng +
            "</b></p>";
        curr_marker.bindPopup(popupContent);

        cluster.addLayer(curr_marker);
        bounds_arr.push(point_coords);
      }

      // devolve as coordenadas do destaque da equipa
      text_coords = gon.highlight_latlon;

      // se estiver a null a equipa nao esta destacada.
      if (text_coords != null) {
        c_arr = parsePointCoordinates(text_coords);
        point_coords = L.latLng(c_arr[1], c_arr[0]);

        curr_marker = L.marker(point_coords, {icon: team_highlight_icon});
        popupContent = "<span>Esta equipa está destacada para as<br>seguintes coordenadas:</span>" +
            "<p>Latitude: <b>" + curr_marker.getLatLng().lat + "</b>,<br>Longitude: <b>" +
            curr_marker.getLatLng().lng + "</b></p>";
        curr_marker.bindPopup(popupContent);

        cluster.addLayer(curr_marker);
        bounds_arr.push(point_coords);
      }

      team_map.addLayer(cluster);

      console.log(bounds_arr);
      team_map.fitBounds(bounds_arr);
    }
  }
  // estamos na pagina para editar utilizador - /users/12/edit
  else if (users_pages && edit_page) {
    console.log("PÁGINA PARA EDITAR UTILIZADOR!!!");
  }


//  $('#profile-user-info').pushpin({top: 64});

  /**
   * Positions the tabs
   */
  function positionTabs() {
    var tabs = $('#tab-wrapper');
    if (tabs.length) {
      var nav = $('#nav');
      var search = $('#search');
      var content = $('#content');
      var offsetTop = window.pageYOffset || document.documentElement.scrollTop;

      if (offsetTop > (nav.height() + (search.is(':visible') ? search.height() : 0)) && window.innerWidth > 600) {
        tabs.addClass('fixed');
        content.css({'padding-top': (tabs.height() + parseInt(tabs.css('margin-bottom'))) + 'px'});
      }
      else {
        tabs.removeClass('fixed');
        content.css({'padding-top': 0});
      }
    }
  }

  // Scroll events
  $(window).scroll(function (e) {
    positionTabs();
  });

  // Resize events
  $(window).resize(function (e) {
    positionTabs();
  });

  // Toggle search
  $('a#toggle-search').click(function () {
    var search = $('div#search');
    search.is(":visible") ? search.slideUp() : search.slideDown(function () {
      search.find('input').focus();
    });
    return false;
  });

  /**
   * Listener para quando uma checkbox é marcada ou desmarcada
   */
  $('input:checkbox').change(
      function () {
        // select para escolher o lider
        var select_leader = $('#select_team_leader');
        // select para escolher o user responsavel pela posição da equipa
        var select_team_position = $('#select_team_position');
        var i_value, i_text;

        var len = $("input[name='team[users][]']:checked").length;
        console.log(len);

        if (len > 0)
          $('#team-submit-form').removeClass("disabled");
        else if (len == 0)
          $('#team-submit-form').addClass("disabled");

        if ($(this).is(':checked')) {
          i_value = $(this).prop('value');
          i_text = $(this).next("label").text();

          console.log("++++++ CHECKED ++++++");
          console.log(i_value);
          console.log(i_text);

          select_leader.append($("<option/>", {
            value: i_value,
            text: i_text
          }));
          select_team_position.append($("<option/>", {
            value: i_value,
            text: i_text
          }));
        }
        else if (!($(this).is(':checked'))) {
          i_value = $(this).prop('value');
          console.log("------ UNCHECKED ------");
          $("#select_team_leader option[value=" + i_value + "]").remove();
          $("#select_team_position option[value=" + i_value + "]").remove();
        }
      }
  );

  // inicializa a select box para escolher o lider
  $('select').material_select();
});

/**
 * Este método � executado quando o utilizador carrega no mapa no formulario das equipas
 * Come�a por verificar se ja h� marcador no mapa: se sim, remove-o.
 * A seguir cria um novo marcador no ponto em que o utilizador carregou e abre uma popup
 * com a localiza��o (USAR GEOCODING???)
 */
function onMapClick(e) {
  // o marcador ja foi inicializado, vamos remov�-lo
  if (typeof curr_marker !== "undefined")
    team_map.removeLayer(curr_marker);

  console.log(e);

  var popupContent = "<span>Destaque alterado para as coordenadas:</span>" +
      "<p>Latitude: <b>" + e.latlng.lat + "</b>,<br> Longitude: <b>" + e.latlng.lng + "</b>.</p>";

  curr_marker = L.marker([e.latlng.lat, e.latlng.lng], {icon: team_highlight_icon}).addTo(team_map);
  curr_marker.bindPopup(popupContent).openPopup();

  var new_val = "POINT (" + e.latlng.lng + " " + e.latlng.lat + ")";
  $("#team_latlon_highlight").attr("value", new_val);

  remove_btn.enable();
}

// o parametro "coords" � da forma -> "POINT(33.333 11.111)"
// retorna um vector com 2 posi�oes, uma para cada coordenada
function parsePointCoordinates(coords) {
  var split_res = coords.split("(");
  var new_split_res = split_res[1].split(" ");

  var res = [];
  res.push(new_split_res[0]); //latitude
  res.push(new_split_res[1].split(")")[0]); //longitude

  return res;
}

function secondsTimeSpanToHMS(s) {
  var d = Math.floor(s / 86400); // Get days
  s -= d * 86400;
  var h = Math.floor(s / 3600); //Get whole hours
  s -= h * 3600;
  var m = Math.floor(s / 60); //Get remaining minutes
  s -= m * 60;
  return d + ":" + h + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s); //zero padding on minutes and seconds
}